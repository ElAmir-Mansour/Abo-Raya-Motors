{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load core_filters %}

{% block title %}
{% if LANGUAGE_CODE == 'ar' %}
{{ listing.trim.model.make.name_ar }} {{ listing.trim.model.name_ar }}
{% else %}
{{ listing.trim.model.make.name_en }} {{ listing.trim.model.name_en }}
{% endif %} - Abo Raaya Motors
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <!-- Main Image Gallery -->
        <div class="col-lg-8">
            <div class="glass-card p-3 mb-4">
                {% if listing.image_main|has_file or listing.image_2|has_file or listing.image_3|has_file or listing.image_4|has_file or listing.image_5|has_file %}
                <div id="carouselImages" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner rounded-3">
                        {% if listing.image_main|has_file %}
                        <div class="carousel-item active">
                            <img src="{{ listing.image_main.url }}" class="d-block w-100"
                                style="height: 500px; object-fit: cover;" alt="Main">
                        </div>
                        {% endif %}
                        {% if listing.image_2|has_file %}
                        <div class="carousel-item {% if not listing.image_main|has_file %}active{% endif %}">
                            <img src="{{ listing.image_2.url }}" class="d-block w-100"
                                style="height: 500px; object-fit: cover;" alt="Image 2">
                        </div>
                        {% endif %}
                        {% if listing.image_3|has_file %}
                        <div class="carousel-item">
                            <img src="{{ listing.image_3.url }}" class="d-block w-100"
                                style="height: 500px; object-fit: cover;" alt="Image 3">
                        </div>
                        {% endif %}
                        {% if listing.image_4|has_file %}
                        <div class="carousel-item">
                            <img src="{{ listing.image_4.url }}" class="d-block w-100"
                                style="height: 500px; object-fit: cover;" alt="Image 4">
                        </div>
                        {% endif %}
                        {% if listing.image_5|has_file %}
                        <div class="carousel-item">
                            <img src="{{ listing.image_5.url }}" class="d-block w-100"
                                style="height: 500px; object-fit: cover;" alt="Image 5">
                        </div>
                        {% endif %}
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselImages"
                        data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselImages"
                        data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                    </button>
                </div>
                {% else %}
                <div class="d-flex align-items-center justify-content-center"
                    style="height: 500px; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 12px;">
                    <i class="bi bi-car-front" style="font-size: 8rem; color: var(--amber-gold); opacity: 0.3;"></i>
                </div>
                {% endif %}
            </div>

            <!-- Description -->
            <div class="glass-card p-4 mb-4">
                <h3>{% trans "Description" %}</h3>
                <p class="text-gray-200">{{ listing.description|linebreaks }}</p>
            </div>

            <!-- Specifications -->
            <div class="glass-card p-4">
                <h3 class="mb-4">{% trans "Specifications" %}</h3>
                <div class="row g-3">
                    <div class="col-6 col-md-4">
                        <div class="glass-card-light p-3">
                            <div class="text-gray-200 small">{% trans "Year" %}</div>
                            <div class="h5 text-white">{{ listing.trim.year }}</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4">
                        <div class="glass-card-light p-3">
                            <div class="text-gray-200 small">{% trans "Engine" %}</div>
                            <div class="h5 text-white">{{ listing.trim.engine_cc }} cc</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4">
                        <div class="glass-card-light p-3">
                            <div class="text-gray-200 small">{% trans "Horsepower" %}</div>
                            <div class="h5 text-white">{{ listing.trim.horsepower }} HP</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4">
                        <div class="glass-card-light p-3">
                            <div class="text-gray-200 small">{% trans "Transmission" %}</div>
                            <div class="h5 text-white">{{ listing.trim.get_transmission_display }}</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4">
                        <div class="glass-card-light p-3">
                            <div class="text-gray-200 small">{% trans "Fuel Type" %}</div>
                            <div class="h5 text-white">{{ listing.trim.get_fuel_type_display }}</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4">
                        <div class="glass-card-light p-3">
                            <div class="text-gray-200 small">{% trans "Fuel Consumption" %}</div>
                            <div class="h5 text-white">{{ listing.trim.fuel_consumption }} L/100km</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4">
                        <div class="glass-card-light p-3">
                            <div class="text-gray-200 small">{% trans "Odometer" %}</div>
                            <div class="h5 text-white">{{ listing.odometer|floatformat:0 }} km</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4">
                        <div class="glass-card-light p-3">
                            <div class="text-gray-200 small">{% trans "Color" %}</div>
                            <div class="h5 text-white">{{ listing.color }}</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4">
                        <div class="glass-card-light p-3">
                            <div class="text-gray-200 small">{% trans "Location" %}</div>
                            <div class="h5 text-white">{{ listing.get_location_display }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Price & Contact -->
            <div class="glass-card p-4 mb-4 sticky-top" style="top: 100px;">
                <div class="listing-price mb-3">{{ listing.price|floatformat:0 }} EGP</div>

                <h4 class="mb-3">
                    {% if LANGUAGE_CODE == 'ar' %}
                    {{ listing.trim.model.make.name_ar }} {{ listing.trim.model.name_ar }}
                    {% else %}
                    {{ listing.trim.model.make.name_en }} {{ listing.trim.model.name_en }}
                    {% endif %}
                </h4>

                <!-- Smart Badges -->
                <div class="mb-4">
                    {% if listing.trim.fuel_consumption < 6.5 %} <span class="badge badge-excellent mb-2">
                        <i class="bi bi-fuel-pump"></i> {% trans "Fuel Saver" %}
                        </span>
                        {% endif %}

                        {% if listing.trim.horsepower > 250 %}
                        <span class="badge badge-verified mb-2">
                            <i class="bi bi-speedometer"></i> {% trans "High Performance" %}
                        </span>
                        {% endif %}

                        {% if listing.trim.fuel_type == 'ELECTRIC' %}
                        <span class="badge badge-good mb-2">
                            <i class="bi bi-lightning-charge"></i> {% trans "Electric" %}
                        </span>
                        {% endif %}

                        {% if listing.odometer < 50000 %} <span class="badge badge-excellent mb-2">
                            <i class="bi bi-star-fill"></i> {% trans "Low Mileage" %}
                            </span>
                            {% endif %}
                </div>

                <!-- Show Phone Button -->
                <button onclick="revealPhone({{ listing.pk }}, this)" class="btn-primary w-100 mb-3">
                    <i class="bi bi-telephone-fill"></i> {% trans "Show Phone Number" %}
                </button>

                <!-- Seller Info -->
                <div class="glass-card-light p-3">
                    <h6>{% trans "Seller Information" %}</h6>
                    <p class="mb-1">
                        <i class="bi bi-person"></i> {{ listing.seller.username }}
                    </p>
                    {% if listing.seller.is_verified_dealer %}
                    <span class="badge badge-success">
                        <i class="bi bi-patch-check-fill"></i> {% trans "Verified Dealer" %}
                    </span>
                    {% endif %}
                    <p class="text-muted small mt-2 mb-0">
                        <i class="bi bi-eye"></i> {{ listing.views }} {% trans "views" %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Related Listings -->
    {% if related_listings %}
    <div class="mt-5">
        <h3 class="mb-4">{% trans "Similar Listings" %}</h3>
        <div class="row g-4">
            {% for related in related_listings %}
            <div class="col-md-6 col-lg-3">
                <div class="listing-card">
                    <div
                        style="overflow: hidden; height: 200px; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); display: flex; align-items: center; justify-content: center;">
                        {% if related.image_main|has_file %}
                        <img src="{{ related.image_main.url }}" alt="{{ related.trim }}"
                            style="width: 100%; height: 100%; object-fit: cover;">
                        {% else %}
                        <i class="bi bi-car-front" style="font-size: 3rem; color: var(--amber-gold); opacity: 0.3;"></i>
                        {% endif %}
                    </div>
                    <div class="listing-card-body">
                        <div class="listing-price">{{ related.price|floatformat:0 }} EGP</div>
                        <h5 class="listing-title">
                            {% if LANGUAGE_CODE == 'ar' %}
                            {{ related.trim.model.make.name_ar }} {{ related.trim.model.name_ar }}
                            {% else %}
                            {{ related.trim.model.make.name_en }} {{ related.trim.model.name_en }}
                            {% endif %}
                        </h5>
                        <a href="{% url 'core:listing_detail' related.pk %}"
                            class="btn-secondary w-100 mt-2 d-inline-block text-center">
                            {% trans "View Details" %}
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}